image: python:3.12

# Cache pour les dépendances Python
cache:
  paths:
    - .cache/pip
    - venv/

# Définition des stages
stages:
  - test
  - lint
  - docs
  - build

# Variables globales
variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHONPATH: "$CI_PROJECT_DIR"

# Installation des dépendances
.setup: &setup
  before_script:
    - python -V
    - pip install virtualenv
    - virtualenv venv
    - source venv/bin/activate
    - pip install -r requirements.txt
    - pip install pytest pytest-cov flake8 black docformatter sphinx sphinx-rtd-theme

# Job de test
test:
  <<: *setup
  stage: test
  script:
    - pytest --cov=src tests/ --cov-report=xml --cov-report=term-missing --junitxml=test-results.xml
  coverage: '/^TOTAL.*\s+(\d+)%$/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
      junit: test-results.xml
    paths:
      - coverage.xml
      - test-results.xml
    expire_in: 1 week

# Job de vérification du style de code
lint:
  <<: *setup
  stage: lint
  script:
    # Run flake8 and show errors in logs
    - echo "Running flake8..."
    - flake8 src/ tests/ --max-line-length=88 --exclude=__pycache__ --ignore=D203,D212,D215,D400,D401,D403,D405,D406,D407,D408,D409,D410,D411,D412,D413,D414,D415,D416,D417 --output-file=flake8.txt || true
    - cat flake8.txt
    # Run black and show differences in logs
    - echo "Running black..."
    - black --check --skip-string-normalization src/ tests/ --diff > black.txt || true
    - cat black.txt
    # Run docformatter and show differences in logs
    - echo "Running docformatter..."
    - docformatter --check --wrap-summaries 88 --wrap-descriptions 88 src/ tests/ --recursive > docformatter.txt || true
    - cat docformatter.txt
  artifacts:
    reports:
      codequality: flake8.txt
    paths:
      - flake8.txt
      - black.txt
      - docformatter.txt
    expire_in: 1 week
  allow_failure: true # Permet au pipeline de continuer même si le linting échoue

# Job de génération de documentation
docs:
  <<: *setup
  stage: docs
  script:
    - cd docs
    - sphinx-build -b html source build
  artifacts:
    paths:
      - docs/build
    expire_in: 1 week

# Job de création du package
build:
  <<: *setup
  stage: build
  script:
    - python setup.py sdist bdist_wheel
  artifacts:
    paths:
      - dist/
    expire_in: 1 week

# Règles pour l'exécution du pipeline
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "production"'
    - if: '$CI_COMMIT_BRANCH =~ /^feature\/.*/'
    - if: "$CI_COMMIT_TAG"
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
